Релиз у нас в кармане
=====================

Существуют по крайней мере три подхода к поставке и последующему
сопровождению программного обеспечения[^1]. Первый подход --- поставка
*как есть*. Набор программ обыкновенно собирается в той же среде, в
которой ведётся вся разработка. Затем результат сборки устанавливается
на целевую систему вручную. Вручную же производится и настройка. Этот
подход оправдан лишь в самых тривиальных случаях, требует больших
трудозатрат для воспроизведения и ещё больших --- для обновлении
системы. Следующий уровень --- поставка в виде *пакетов*. Благодаря
использованию диспетчера пакетов этот вариант избавляет практически от
всех проблем предыдущего. Но, вместе с тем, создаёт новые. Например,
из-за сравнительной простоты установки и удаления отдельных пакетов,
целевая система может случайно быть приведена в состояние, отличное от
ожидаемого. Вопрос "Какая версия ПО установлена?" уже может быть
задан, а вот ответ на него не всегда очевиден. И наконец третий
подход --- *дистрибутив*.


Большие и маленькие дистрибутивы
--------------------------------

В своём классическом виде дистрибутив --- это дистрибутив ОС, который
складывается из набора пакетов и инсталлятора --- программы для
установки подмножества этих пакетов на целевую систему и их
настройки. К дистрибутиву ОС предъявляются достаточно  серьёзные
требования: множество пакетов должно быть замкнуто по зависимостям
(т.е. никакой пакет дистрибутива не должен требовать для своей работы
пакетов за его пределами), а инсталлятор --- способным работать на
широком спектре оборудования.

Важной особенностью дистрибутива является также его
формальное единство: каждый дистрибутив связан с вполне определённым
сетевым источником (URL) или носителем информации (CD/DVD/flash),
имеет дату выпуска, собственный номер версии и, как правило, кодовое
имя. Благодаря этому свойству, дистрибутивный подход находит
применение не только по отношению к большим и сверхбольшим программным
комплексам, но также оказывается крайне полезен для поставки и
сопровождения сравнительно небольших по размеру систем прикладного
ПО. В отличие от дистрибутивов ОС, дистрибутивы прикладного ПО,
конечно же, не обладают в полной мере свойством замкнутости: напротив,
входящие в них программы по обыкновению требуют для своей работы
определённых компонентов ОС, предоставляемых пакетами базового
дистрибутива. Из-за этой особенности такие дистрибутивы получили
название дополнительных репозиториев или репозиториев-оверлеев.

Приведём несколько примеров. Собственно термин "оверлей", по-видимому,
происходит из Gentoo Linux (а возможно, и FreeBSD), где оверлей
является стандартным и доступным для пользователя механизмом
расширения набора ПО, доступного для сборки и установки[^2]. Другим
примером являются персональные репозитории пакетов (PPA) в Ubuntu
Linux[^3]. Полный цикл упаковки и последующего развёртывания
дистрибутива ОС с целевым набором дополнительного ПО предоставляет
система Docker[^4] --- яркий пример применения дистрибутивного подхода
к проблеме поставки и сопровождения целевого ПО (программного
продукта).

Достаточно часто средства для организации дистрибутивов-оверлеев с
целевым ПО, предоставляемые публично как услуга, являются также
средствами сборки с непрерывной интеграцией, т.е. осуществляют
регулярную пересборку, формальное и синтетическое тестирование
ПО по мере его разработки. Примерами таких публичных систем
являются широко известная Suse Open Build Service (OBS)[^5] и менее
известная GearRepo[^6] от сообщества ALT Linux Team.

Слово "карман" для обозначения подобного репозитория-оверлея принято в
рамках проекта Sisyphus[^7]. Правда со словом "карманы" там связывают
прежде всего публичный сервис для сборки и публикации репозиториев,
нежели сами репозитории-оверлеи как таковые. В отличие от сизифовых
карманов, настоящий проект --- Pocket --- прежде всего ориентируется
на конечного пользователя, на распределённую, а не на централизованную
серверную инфраструктуру. Соответственно, слово "карман" ассоциируется
у автора с лекговесностью, простотой использования и переносимостью ПО
для сборки и публикации небольших репозиториев.


Pocket
------

Программа `pocket` предназначена для сборки пакетов ПО под
определённый диспетчер пакетов и ОС, в изолированном окружении с
пониженными правами (restricted chroot), с итеративным формированием
репозитория-оверлея --- так называемого "кармана". Pocket использует
`hasher-priv`[^8] для создания изолированного окружения и выполнения в
нём программ. Подготовка окружения, сборка и все прочие действия
выполняются под управлением сценария для `make`, получившего название
`Pocketfile`.

Благодаря использованию `hasher-priv`, взаимодействие со сборочным
окружением не является привилегированной операцией и не требует прав
суперпользователя (в отличии, например, от `pbuilder` в Debian).

Логика работы с `pocket` довольно проста: пользователь использует
команды `sync-in` и `sync-out` для передачи исходных файлов между
пользовательской и сборочной средой и команды `build` и `rebuild` для
сборки и контрольной пересборки пакета. Результат успешной сборки
добавляется в локальный репозиторий-карман, доступный вне сборочной
среды. При сборке новой версии пакета она замещает старую. При каждом
обновлении сборочной среды к числу доступных для установки пакетов
автоматически прибавляется содержимое кармана: таким образом результат
предыдущих сборок оказывается доступен для следующих.

Кроме сборки, `pocket` является инструментом для тестирования
свежесобранных пакетов на устанавливаемость. Для этой цели
предназначена команда `install-repo`, которая выполняет установку всех
содержащихся в кармане пакетов в *отдельное* чистое окружение.

`Pocketfile` отражает особенности сборки пакетов под конкретный
пакетные диспетчер и ОС --- для каждой такой комбинации может быть
предусмотрена своя версия `Pocketfile`.

### debian.pocket

Версия `pocket` для ОС Debian GNU/Linux умеет собирать `*.deb`, а
репозиторий-карман совместим с `apt`. Для первичной подготовки
сборочного окружения (bootstrap) используются программы `dpkg` и
`debootstrap`, которые вызываются на первой стадии подготовки
окружения и должны быть доступны в пользовательской среде. Все
последующие операции выполняются уже внутри сборочного окружения и не
требуют установки дополнительного ПО в пользовательскую
среду. Благодаря такому небольшому набору зависимостей, сборочное
окружение для Debian может быть развёрнуто на ОС, отличной от Debian,
например на ALT Linux. На промежуточной стадии подготовки используется
статически собранная `busybox` из пакета `busybox-static` дистрибутива
Debian. На завершающей стадии подготовки --- уже "полноразмерные"
версии `dpkg` и `apt`.

Вычисление сборочных зависимостей выполняется с помощью
`mk-build-deps` из пакета `devscripts`. Сборка пакета --- посредством
`dpkg-buildpackage`. Для формирования и обновления репозитория-кармана
используется программа `reprepro`.


Текущая версия
--------------

<http://git.altlinux.org/people/manowar/packages/pocket.git>

На момент написания настоящей заметки, версия `pocket` v0.1.0 является
первой и нестабильной. Она обладает рядом недостатков, главный из
которых --- отсутствие документации. Ко второму недостатку можно
отнести отсутствие программы-обёртки над `Pocketfile`, которая делала
бы его использование простым и удобным.

Кроме исправления вышеперечисленных недостатков, в последующих версиях
`pocket` планируется добавление возможности публикации карманов и
подключения опубликованных карманов в качестве дополнительных
репозиториев, доступных для сборочного окружения. Вероятно, со
временем могут появится `Pocketfile`s для поддержки окружений,
отличных от Debian.


Литература
----------

[^1]: *Виталий Липатов*, Korinf: трудности на пути к универсальной
сборочной системе. [Протва--2012](http://www.altlinux.ru/media/protva-2012.pdf).
[^2]: <http://wiki.gentoo.org/wiki/Overlay>
[^3]: <https://help.launchpad.net/Packaging/PPA>
[^4]: <https://docs.docker.com/>
[^5]: <https://ru.opensuse.org/Portal:Служба_сборки>. См. также
"Open Build Service --- создаём свои репозитории" на сайте
[habrahabr.ru](http://habrahabr.ru/post/160609/).
[^6]: <http://www.altlinux.org/GearRepo>
[^7]: <http://www.altlinux.org/Pockets>
[^8]: <http://git.altlinux.org/people/ldv/packages/hasher-priv.git>
